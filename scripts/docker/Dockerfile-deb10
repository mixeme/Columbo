FROM debian:buster

# Suppress prompting from apt
ARG DEBIAN_FRONTEND=noninteractive

RUN apt update -y && apt install -y apt-utils && apt install -y wget git
# Install basic packages

# https://devguide.python.org/getting-started/setup-building/index.html#build-dependencies
# See reference for CPython dependencies:
RUN echo "deb-src http://deb.debian.org/debian/ buster main" >> /etc/apt/sources.list \
	&& apt update -y \
	&& apt build-dep -y python3
RUN apt install -y	build-essential \
					gdb lcov pkg-config \
					libbz2-dev libffi-dev libgdbm-dev libgdbm-compat-dev liblzma-dev \
					libncurses5-dev libreadline6-dev libsqlite3-dev libssl-dev \
					lzma lzma-dev tk-dev uuid-dev zlib1g-dev
#RUN apt install -y software-properties-common libnss3-dev 

# Compile & install CPython 3.9.18 from source
RUN mkdir /pybuild \
	&& cd /pybuild \
	&& wget https://www.python.org/ftp/python/3.9.18/Python-3.9.18.tgz \
	&& tar -xzf Python-*.tgz \
	&& cd Python-3.9*/ \
	&& ./configure --enable-optimizations --with-lto --enable-shared LDFLAGS="-Wl,--rpath=/usr/local/lib" \
	&& make altinstall \
	&& cd / \
	&& rm -R /pybuild

#RUN apt install -y glib2.0 libdbus-1-dev libdbus-glib-1-dev
#RUN libdbusextended-qt5-dev libdbus-c++-dev 

#RUN apt install -y qt5-default qt5-gtk-platformtheme qt5-style-plugins

# Install Python packages with `pip`
#RUN python3.9 -m pip install --upgrade pip \
#	&& python3.9 -m pip install dbus-python dbus-next

#RUN	python3.9 -m pip install pyqt5 --config-settings --confirm-license= --verbose
#	&& python3.9 -m pip install pyqt5 --config-settings --confirm-license= --verbose
#python3.9 -m pip install pyinstaller 

# Overwrite symlink to the installed Python
#RUN rm /usr/bin/python3 && ln -s /usr/local/bin/python3.9 /usr/bin/python3

# Got from https://github.com/jozo/docker-pyqt5/blob/master/default/Dockerfile
# This fix: libGL error: No matching fbConfigs or visuals found
#ENV LIBGL_ALWAYS_INDIRECT=1

#RUN mkdir /project
#WORKDIR /project

#CMD ["/bin/bash", "/project/scripts/build-lnx.sh", "onedir"]

# Image build
# docker build --tag mixeme/columbo:debian-buster --file scripts/docker/Dockerfile-deb10 scripts/docker
#
# Test run from source
# docker run --user $(id -u):$(id -g) -it --rm --name columbo-build -v $PWD:/project -v /etc/passwd:/etc/passwd:ro -v /etc/group:/etc/group:ro -v /etc/shadow:/etc/shadow:ro -v /tmp/.X11-unix:/tmp/.X11-unix -e DISPLAY=$DISPLAY mixeme/columbo:debian-buster python3.9 main.py
#
# Build binary
# docker run --user $(id -u):$(id -g) -it --rm --name columbo-build -v $PWD:/project -v /etc/passwd:/etc/passwd:ro -v /etc/group:/etc/group:ro -v /etc/shadow:/etc/shadow:ro mixeme/columbo:debian-buster
